<?php
  if (!$this->edit)
  {
?>
     <a href="<?php echo $this->escape($this->getURL(null, 'edit')); ?>">Edit</a>
<?php
  }
  else
  {
?>
     <a href="<?php echo $this->escape($this->getURL(null, 'endEdit')); ?>">End Edit</a>
<?php
  }
?>
    <form action="<?php echo $this->escape($this->getURL(null, 'saveResult')); ?>" method="POST">
      <table id="features-table"
             summary="Language features and the first editions of ECMAScript or first versions of the implementations that introduced or supported them">
        <thead>
          <tr>
<?php
  if ($this->edit)
  {
?>
            <td style="width: 7em">&nbsp;</td>
<?php
  }
?>
            <th id="atoz">
<?php
  if ($this->edit)
  {
?>
              <a href="<?php echo $this->escape($this->getURL('feature', 'add')); ?>"
                 title="Add feature"
                 class="add">Add</a>
<?php
  }
?>
              Feature
            </th>
            <th><a href="#ecmascript">ECMAScript</a></th>
            <th>This <abbr title="implementation">impl.</abbr><?php
                // $footnotes->add('this-impl', '', $scriptEngineTest, '');
                ?><br>
              <script type="text/javascript">
                var implementation = jsx.object.isMethod(this, "ScriptEngine") ? ScriptEngine() : '';
                if (implementation)
                {
                  implementation = implementation.replace(/"/g, "&quot;").replace(/</g, "&gt;");
                  var version = '';
                  if (jsx.object.isMethod(this, "ScriptEngineMajorVersion"))
                  {
                    version = ScriptEngineMajorVersion();

                    if (jsx.object.isMethod(this, "ScriptEngineMinorVersion"))
                    {
                      version += "." + ScriptEngineMinorVersion();

                      if (jsx.object.isMethod(this, "ScriptEngineBuildVersion"))
                      {
                        version += "." + ScriptEngineBuildVersion();
                      }
                    }

                    if (version)
                    {
                      version = version.replace(/"/g, "&quot;").replace(/</g, "&gt;");
                    }
                  }
                      
                  document.write(
                    '<input type="hidden" name="implementation" value="' + implementation + '">'
                    + '<input type="hidden" name="version" value="' + version + '">');
                }
              </script>
              <input type="submit" name="submitResults" value="Submit results"></th>
<?php
  $implementations = $this->implementations;
  foreach ($implementations as $key => $impl)
  {
?>
            <td><?php
              if ($impl->acronym !== '')
              {
                ?><abbr title="<?php echo $this->escape($impl->name); ?>"><?php
                echo $this->escape($impl->acronym);
              }
              else
            {
                echo $this->escape($impl->name);
              }
        
              if ($impl->acronym !== '')
              {
                ?></abbr><?php
              }
              
              if ($this->edit)
              {
                ?><br>
                <a href="<?php echo $this->escape($this->getURL('implementation', 'edit', $impl->id)); ?>"
                   class="edit">Edit</a><?php
              }
            ?></td>
<?php
  }
  
  if ($this->edit)
  {
?>
            <td><a href="<?php echo $this->escape($this->getURL('implementation', 'add')); ?>"
                   title="Add implementation"
                   class="add">Add</a></td>
<?php
  }
?>
          </tr>
        </thead>
        <tbody id="scroller" class="scroll">
<?php
  foreach ($this->features as $key => $feature)
  {
?>
          <tr<?php if ($this->isSafe($feature->id)) { ?> class="safe"<?php } ?>>
<?php
    if ($this->edit)
    {
?>
            <td><a href="<?php echo $this->escape($this->getURL('feature', 'edit', $feature->id)); ?>"
                   class="edit">Edit</a>
                <form action="<?php echo $this->escape($this->getURL('feature', 'delete', $feature->id)); ?>" method="POST"
                      onsubmit="return window.confirm('Delete feature &quot;<?php echo addslashes($this->escape(strip_tags($feature->code))); ?>&quot;?')"
                      style="display: inline">
                  <input type="hidden" name="id" value="<?php echo $feature->id; ?>">
                  <button type="submit" class="negative delete">Delete</button>
                </form></td>
<?php
    }
?>
            <th id="feature<?php echo $feature->id; ?>"<?php
                if ($feature->title)
                {
                  ?> title="<?php echo $this->escape($feature->title); ?>"<?php
                }
                ?>><?php echo $feature->code; ?></th>
            <td><?php
              $edition = $feature->edition;
              if ($edition)
              {
                if ($edition === '-')
                {
                  ?><span title="Non-standard">&#8722;</span><?php
                }
                else
                {
                  echo $edition;

                  if ($feature->section)
                  {
                    ?> <span class="section" title="Specification section">[<?php
                      echo $feature->section;
                    ?>]</span><?php
                  }
                }
              }
            ?></td>
            <td<?php
              $id = 'td' . ($key + 1);
              $testcases = $feature->testcases;
              if (count($testcases) > 0)
              {
                echo " id='$id'";
                echo ' title="'
                  . $this->escape(
                      implode("\n",
                        array_map(
                          create_function('$e, $i', 'return "Test " . ($i + 1) . ": " . $e->code;'),
                          $testcases, array_keys($testcases)
                        )
                      )
                    )
                  . '"';
              }
              else
            {
                echo ' title="Not applicable: No automated test case'
                  . ' is available for this feature.  If possible, please'
                  . ' click the feature code in the first column to run'
                  . ' a manual test."';
              }
              ?>><?php
              if (count($testcases) > 0)
              {
                ?><script type="text/javascript">
                    var results = new Array();
                  </script><?php
                foreach ($testcases as $testcase_key => $testcase)
                {
                  ?><script type="text/javascript">
                    var result = false;
                  </script>
                  <script type="<?php
                    if ($testcase->alt_type)
                    {
                      echo $this->escape($testcase->alt_type);
                    }
                    else
                    {
                      echo 'text/javascript';
                    }
                    ?>">
                    <?php
                      $code = $testcase->code;
                      if ($testcase->quoted)
                      {
                        $code = '"' . preg_replace('/(\\r?\\n|\\r)/', '\\n', addslashes($code)) . '"';
                      }
                    ?>
                    result = jsx.debug.test(<?php echo str_replace('</', '<\\/', $code); ?>, true, false);
                  </script>
                  <script type="text/javascript">
                    results[<?php echo $testcase_key; ?>] = result;
                    document.write('<input type="hidden" name="results[<?php echo $testcase->id; ?>]" value="' + (result ? '1' : '0') + '">');
                  </script><?php
                }
                ?><script type="text/javascript">
                  var count = 0;
                  var resultsStr = "";
                  for (var i = 0, len = results.length; i < len; ++i)
                  {
                    var result = results[i];
                    if (result)
                    {
                      ++count;
                    }
                    
                    resultsStr += "Test " + (i + 1) + ": "
                      + (result ? "passed" : "failed")
                      + (i < results.length - 1 ? "\n" : "");
                  }
  
                  var text = (count == len) ? "+" : (count == 0 ? "&#8722;" : "*");
                  
                  document.write('<span title="' + resultsStr + '">' + text + '<\/span>');
                </script><?php
              }
              else
            {
                echo '<abbr>N/A</abbr>';
              }
              ?></td>
<?php
    /* No results to show if there are no testcases */
    $num_testcases = count($feature->testcases);
    if ($num_testcases > 0)
    {
      $feature_results = Application::getParam('forFeatures', $this->results);
      if (is_array($feature_results))
      {
        $impl_results = Application::getParam($feature->id, $feature_results);
        if (is_array($implementations) && is_array($impl_results))
        {
          foreach ($implementations as $key => $implementation)
          {
?>
        			<td><?php
        			  $impl_result = Application::getParam($implementation->id, $impl_results);
        			  if (is_array($impl_result))
        			  {
        			    ?><table class="results"><?php
          			  foreach ($impl_result as $version_id => $result)
          			  {
          			    $success_string = '';
          			    $successes = $result['successes'];
          			    if ($successes === 0)
          			    {
          			      $success_string = '&#8722;';
          			    }
        			      else if ($successes < $num_testcases)
          			    {
          			      $success_string = '*';
          			    }
          			    else
          			    {
          			      $success_string = '+';
          			    }
        			      ?>
                    <tr>
                      <th><?php echo $result['version']; ?></th>
                      <td><?php echo $successes. '/' . $num_testcases
        			              . '&nbsp;(' . $success_string . ')'; ?></td>
                    </tr><?php
          			  }
          			  ?>
                  </table><?php
        			  }
        			  ?></td>
<?php
          }
        }
      }
    }
?>
            </tr>
<?php
  }
?>
          </tbody>
      </table>
    </form>
